{% extends "base.html" %}
{% block title %}Комната учителя{% endblock %}
{% block content %}
<div class="student">
	<div class="column">
		<h3 class="h3 bold username">Загрузка...</h3>
		<h4 class="h4 normal email"></h4>
		<h4 class="h4 normal phone"></h4>

		<!-- Форма создания теста -->
		<div class="test-creator">
			<h2>Создать новый тест</h2>
			<form id="createTestForm">
				<div class="form-group">
					<label for="testTitle">Название теста:</label>
					<input type="text" id="testTitle" required class="form-control">
				</div>
				<div class="form-group">
					<label for="testDescription">Описание:</label>
					<textarea id="testDescription" class="form-control"></textarea>
				</div>
				<div class="form-group">
					<label>Система оценок:</label>
					<div class="grading-system">
						<div>
							<label>5 (от %):</label>
							<input type="number" id="grade5" value="90" min="0" max="100" class="form-control">
						</div>
						<div>
							<label>4 (от %):</label>
							<input type="number" id="grade4" value="80" min="0" max="100" class="form-control">
						</div>
						<div>
							<label>3 (от %):</label>
							<input type="number" id="grade3" value="70" min="0" max="100" class="form-control">
						</div>
						<div>
							<label>2 (от %):</label>
							<input type="number" id="grade2" value="60" min="0" max="100" class="form-control">
						</div>
					</div>
				</div>
				<div class="form-group">
					<label for="isOpen">Тест открыт:</label>
					<input type="checkbox" id="isOpen" checked>
				</div>
				<button type="submit" class="btn btn-primary">Создать тест</button>
			</form>
		</div>

		<!-- Секция со списком тестов -->
		<div class="tests-section" style="margin-top: 30px;">
			<h2>Все тесты</h2>
			<div id="testsList" class="tests-list"></div>
		</div>

		<!-- Универсальная форма добавления вопросов -->
		<div class="question-creator" style="display: none; margin-top: 30px;">
			<h2>Добавить вопрос в тест: <span id="currentTestTitle"></span></h2>
			<form id="addQuestionForm">
				<input type="hidden" id="currentTestId">
				<div class="form-group">
					<label for="questionContent">Вопрос:</label>
					<textarea id="questionContent" required class="form-control"></textarea>
				</div>
				<div class="form-group">
					<label for="questionType">Тип вопроса:</label>
					<select id="questionType" class="form-control">
						<option value="single">Один правильный ответ</option>
						<option value="multiple">Несколько правильных ответов</option>
						<option value="text">Текстовый ответ</option>
					</select>
				</div>
				<div class="form-group">
					<label for="questionPoints">Баллы:</label>
					<input type="number" id="questionPoints" value="1" min="1" class="form-control">
				</div>

				<div id="answersContainer">
					<!-- Поля для ответов будут добавляться динамически -->
				</div>

				<div class="form-buttons">
					<button type="button" id="addAnswerBtn" class="btn btn-secondary">Добавить ответ</button>
					<button type="button" id="cancelAddQuestion" class="btn btn-outline-secondary">Отмена</button>
					<button type="submit" class="btn btn-primary">Добавить вопрос</button>
				</div>
			</form>
		</div>
	</div>
</div>
{% endblock %}
{% block scripts %}
<script>
	function getCookie(name) {
		const value = `; ${document.cookie}`;
		const parts = value.split(`; ${name}=`);
		if (parts.length === 2) return parts.pop().split(';').shift();
	}

	const host = "https://olympiad-api.falpin.ru"
	const jwtToken = getCookie('jwt_token');
	let currentUser = null;

    // Загрузка данных пользователя
	async function loadUserData() {
		try {
			const response = await fetch(`${host}/profile`, {
				headers: {
					'Authorization': `Bearer ${jwtToken}`
				}
			});

			if (response.ok) {
				const user = await response.json();
				currentUser = user;
				document.querySelector('.username').textContent = `${user.first_name} ${user.last_name}`;
				document.querySelector('.email').textContent = user.email;
				document.querySelector('.phone').textContent = user.phone;
			} else {
				throw new Error('Не удалось загрузить данные пользователя');
			}
		} catch (error) {
			console.error('Ошибка загрузки пользователя:', error);
		}
	}

    // Загрузка списка тестов
	async function loadTests() {
		try {
			const response = await fetch(`${host}/tests`, {
				headers: {
					'Authorization': `Bearer ${jwtToken}`
				}
			});

			const tests = await response.json();
			renderTests(tests);
		} catch (error) {
			console.error('Ошибка загрузки тестов:', error);
			document.getElementById('testsList').innerHTML = '<p class="error">Ошибка загрузки тестов</p>';
		}
	}

    // Отображение списка тестов
	function renderTests(tests) {
		const testsList = document.getElementById('testsList');
		testsList.innerHTML = '';

		if (tests.length === 0) {
			testsList.innerHTML = '<p>Тесты не найдены</p>';
			return;
		}

		tests.forEach(test => {
			const testElement = document.createElement('div');
			testElement.className = 'test-item';
			testElement.innerHTML = `
                <div class="test-header" data-test-id="${test.id}">
                    <div class="test-title">
                        <h3>${test.title}</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="test-meta">
                        <span>Автор: ${test.creator_first_name} ${test.creator_last_name}</span>
                        <button class="btn btn-sm btn-outline-primary add-question-btn" data-test-id="${test.id}">
                            Добавить вопрос
                        </button>
                    </div>
                </div>
                <div class="test-details">
                    <p>${test.description || 'Описание отсутствует'}</p>
                    <div class="grading-info">
                        <strong>Система оценок:</strong> 
                        5 - от ${test.grading_system[5]}%, 
                        4 - от ${test.grading_system[4]}%, 
                        3 - от ${test.grading_system[3]}%, 
                        2 - от ${test.grading_system[2]}%
                    </div>
                    <div class="questions-list">
                        <p>Загрузка вопросов...</p>
                    </div>
                </div>
			`;
			testsList.appendChild(testElement);

            // Обработчик сворачивания/разворачивания
			const header = testElement.querySelector('.test-header');
			header.addEventListener('click', (e) => {
				if (!e.target.closest('.add-question-btn')) {
					const details = testElement.querySelector('.test-details');
					const isHidden = details.style.display === 'none';

					details.style.display = isHidden ? 'block' : 'none';
					testElement.querySelector('.toggle-icon').textContent = isHidden ? '▲' : '▼';

				loadTestQuestions(test.id, details.querySelector('.questions-list'));
				}
			});

            // Обработчик кнопки добавления вопроса
			const addBtn = testElement.querySelector('.add-question-btn');
			addBtn.addEventListener('click', () => {
				openQuestionForm(test.id, test.title);
			});
		});
	}

    // Загрузка вопросов для конкретного теста
	async function loadTestQuestions(testId, container) {
		try {
			const response = await fetch(`${host}/tests/${testId}`, {
				headers: {
					'Authorization': `Bearer ${jwtToken}`
				}
			});

			const test = await response.json();
			renderQuestions(test.questions, container);
		} catch (error) {
			console.error(`Ошибка загрузки вопросов для теста ${testId}:`, error);
			container.innerHTML = '<p class="error">Ошибка загрузки вопросов</p>';
		}
	}

    // Отображение вопросов
	function renderQuestions(questions, container) {
		if (questions.length === 0) {
			container.innerHTML = '<p>Вопросы отсутствуют</p>';
			return;
		}

		let html = '<div class="questions-container">';
		questions.forEach(question => {
			html += `
                <div class="question-item">
                    <div class="question-header">
                        <strong>${question.content}</strong>
                        <span>(${getQuestionType(question.type)}, ${question.points} баллов)</span>
                    </div>
                    <div class="question-answers">
                        ${renderAnswers(question.answers)}
                    </div>
                </div>
			`;
		});
		html += '</div>';

		container.innerHTML = html;
	}

    // Вспомогательная функция для отображения ответов
	function renderAnswers(answers) {
		if (answers.length === 0) return '<p>Ответы отсутствуют</p>';

		let html = '<ul>';
		answers.forEach(answer => {
			html += `
                <li class="${answer.is_correct ? 'correct-answer' : ''}">
                    ${answer.content} 
                    ${answer.is_correct ? '<span class="correct-badge">✓</span>' : ''}
                </li>
			`;
		});
		html += '</ul>';
		return html;
	}

    // Получение читаемого типа вопроса
	function getQuestionType(type) {
		const types = {
			'single': 'Один ответ',
			'multiple': 'Несколько ответов',
			'text': 'Текстовый ответ'
		};
		return types[type] || type;
	}

    // Открытие формы добавления вопроса
	function openQuestionForm(testId, testTitle) {
		document.getElementById('currentTestId').value = testId;
		document.getElementById('currentTestTitle').textContent = testTitle;
		document.querySelector('.question-creator').style.display = 'block';

        // Прокрутка к форме
		document.querySelector('.question-creator').scrollIntoView({ behavior: 'smooth' });
	}

    // Закрытие формы добавления вопроса
	function closeQuestionForm() {
		document.querySelector('.question-creator').style.display = 'none';
		document.getElementById('questionContent').value = '';
		document.getElementById('questionPoints').value = '1';
		answersContainer.innerHTML = '';
        addAnswerBtn.click(); // Добавляем поле ответа по умолчанию
    }

    document.addEventListener('DOMContentLoaded', function() {
    	loadUserData();
    	loadTests();

        // Форма создания теста
    	const createTestForm = document.getElementById('createTestForm');
    	createTestForm.addEventListener('submit', async function(e) {
    		e.preventDefault();

    		const testData = {
    			title: document.getElementById('testTitle').value,
    			description: document.getElementById('testDescription').value,
    			grading_system: {
    				"5": parseInt(document.getElementById('grade5').value),
    				"4": parseInt(document.getElementById('grade4').value),
    				"3": parseInt(document.getElementById('grade3').value),
    				"2": parseInt(document.getElementById('grade2').value)
    			},
    			is_open: document.getElementById('isOpen').checked
    		};

    		try {
    			const response = await fetch(`${host}/tests`, {
    				method: 'POST',
    				headers: {
    					'Content-Type': 'application/json',
    					'Authorization': `Bearer ${jwtToken}`
    				},
    				body: JSON.stringify(testData)
    			});

    			const result = await response.json();

    			if (response.ok) {
    				alert(`Тест "${testData.title}" создан! ID: ${result.test_id}`);
                    loadTests(); // Обновляем список тестов
                    openQuestionForm(result.test_id, testData.title); // Открываем форму вопросов
                } else {
                	throw new Error(result.message || 'Ошибка при создании теста');
                }
            } catch (error) {
            	console.error('Ошибка:', error);
            	alert('Ошибка при создании теста: ' + error.message);
            }
        });

        // Форма добавления вопросов
    	const addQuestionForm = document.getElementById('addQuestionForm');
    	const answersContainer = document.getElementById('answersContainer');
    	const addAnswerBtn = document.getElementById('addAnswerBtn');
    	const cancelAddQuestion = document.getElementById('cancelAddQuestion');

        // Инициализация поля ответа
    	function initAnswerField() {
    		answersContainer.innerHTML = '';
    		addAnswerBtn.click();
    	}
    	initAnswerField();

        // Добавление нового поля для ответа
    	addAnswerBtn.addEventListener('click', function() {
    		const answerGroup = document.createElement('div');
    		answerGroup.className = 'answer-group';
    		answerGroup.innerHTML = `
                <input type="text" placeholder="Текст ответа" class="form-control answer-content">
                <label class="answer-correct">
                    Правильный: <input type="checkbox" class="answer-checkbox">
                </label>
                <button type="button" class="btn btn-sm btn-danger remove-answer">×</button>
    		`;
    		answersContainer.appendChild(answerGroup);

            // Удаление поля ответа
    		answerGroup.querySelector('.remove-answer').addEventListener('click', function() {
    			answersContainer.removeChild(answerGroup);
    		});
    	});

        // Обработка отправки формы вопроса
    	addQuestionForm.addEventListener('submit', async function(e) {
    		e.preventDefault();

    		const testId = document.getElementById('currentTestId').value;
    		const questionType = document.getElementById('questionType').value;
    		const questionContent = document.getElementById('questionContent').value;
    		const questionPoints = parseInt(document.getElementById('questionPoints').value);

            // Собираем ответы
    		const answerGroups = answersContainer.querySelectorAll('.answer-group');
    		const answers = [];

    		answerGroups.forEach(group => {
    			const content = group.querySelector('.answer-content').value;
    			const isCorrect = group.querySelector('.answer-checkbox').checked;

    			if (content.trim()) {
    				answers.push({
    					content: content,
    					is_correct: isCorrect
    				});
    			}
    		});

            // Для текстовых вопросов добавляем пустой массив ответов
    		const answersData = questionType === 'text' ? [] : answers;

    		try {
                // Создаем FormData
    			const formData = new FormData();

// Добавляем поля, как если бы это была форма
    			formData.append('content', questionContent);
    			formData.append('type', questionType);
    			formData.append('points', questionPoints);

// answersData — предположим, что это массив или объект
// Если это JSON-объект, можно сериализовать в строку:
    			formData.append('answers', JSON.stringify(answersData));

// Если есть файлы, их тоже можно добавить
// например: formData.append('file', fileInput.files[0]);

// Отправляем запрос
    			const response = await fetch(`${host}/tests/${testId}/questions`, {
    				method: 'POST',
    				headers: {
        // Не указываем Content-Type — браузер сам определит multipart/form-data
    					'Authorization': `Bearer ${jwtToken}`
    				},
    				body: formData
    			});

    			const result = await response.json();

    			if (response.ok) {
    				alert(`Вопрос добавлен в тест!`);

                    // Обновляем вопросы в соответствующем тесте
    				const testElement = document.querySelector(`.test-header[data-test-id="${testId}"]`).closest('.test-item');
    				if (testElement) {
    					const questionsContainer = testElement.querySelector('.questions-list');
    					if (questionsContainer) {
    						loadTestQuestions(testId, questionsContainer);
    					}
    				}

                    // Сбрасываем форму
    				document.getElementById('questionContent').value = '';
    				document.getElementById('questionPoints').value = '1';
    				initAnswerField();
    			} else {
    				throw new Error(result.message || 'Ошибка при добавлении вопроса');
    			}
    		} catch (error) {
    			console.error('Ошибка:', error);
    			alert('Ошибка при добавлении вопроса: ' + error.message);
    		}
    	});

        // Отмена добавления вопроса
    	cancelAddQuestion.addEventListener('click', closeQuestionForm);
    });
</script>

<style>
	.form-group {
		margin-bottom: 15px;
	}

	.form-control {
		width: 100%;
		padding: 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
	}

	.grading-system {
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		gap: 10px;
	}

	.answer-group {
		display: flex;
		align-items: center;
		gap: 10px;
		margin-bottom: 10px;
	}

	.answer-content {
		flex: 1;
	}

	.answer-correct {
		white-space: nowrap;
	}

	.form-buttons {
		display: flex;
		gap: 10px;
		margin-top: 20px;
	}

	.btn {
		padding: 8px 15px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
	}

	.btn-primary {
		background-color: #007bff;
		color: white;
	}

	.btn-secondary {
		background-color: #6c757d;
		color: white;
	}

	.btn-outline-secondary {
		background-color: transparent;
		border: 1px solid #6c757d;
		color: #6c757d;
	}

	.btn-danger {
		background-color: #dc3545;
		color: white;
	}

	.btn-sm {
		padding: 3px 6px;
		font-size: 12px;
	}

	/* Стили для списка тестов */
	.tests-list {
		margin-top: 20px;
	}

	.test-item {
		border: 1px solid #ddd;
		border-radius: 5px;
		margin-bottom: 15px;
		overflow: hidden;
	}

	.test-header {
		padding: 15px;
		background-color: #f8f9fa;
		cursor: pointer;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.test-title {
		display: flex;
		align-items: center;
		gap: 10px;
	}

	.test-title h3 {
		margin: 0;
		font-size: 1.2rem;
	}

	.toggle-icon {
		font-size: 0.8rem;
	}

	.test-meta {
		display: flex;
		align-items: center;
		gap: 15px;
	}

	.test-details {
		padding: 15px;
		border-top: 1px solid #eee;
		display: none;
	}

	.grading-info {
		margin: 10px 0;
		padding: 10px;
		background-color: #f0f8ff;
		border-radius: 4px;
	}

	.questions-list {
		margin-top: 20px;
	}

	.questions-container {
		display: flex;
		flex-direction: column;
		gap: 15px;
	}

	.question-item {
		padding: 15px;
		border: 1px solid #eee;
		border-radius: 4px;
		background-color: #fafafa;
	}

	.question-header {
		display: flex;
		justify-content: space-between;
		margin-bottom: 10px;
	}

	.question-answers ul {
		list-style-type: none;
		padding: 0;
		margin: 0;
	}

	.question-answers li {
		padding: 5px 10px;
		margin-bottom: 5px;
		background-color: white;
		border: 1px solid #ddd;
		border-radius: 3px;
	}

	.correct-answer {
		border-left: 3px solid #28a745 !important;
		background-color: #f0fff4 !important;
	}

	.correct-badge {
		margin-left: 10px;
		color: #28a745;
		font-weight: bold;
	}

	.error {
		color: #dc3545;
	}
</style>
{% endblock %}